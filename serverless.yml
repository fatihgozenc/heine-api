service:
  name: heine-api

plugins:
  - serverless-webpack
  - serverless-dotenv-plugin
  - serverless-offline
  - serverless-apigw-binary

custom: 
  serverless-offline:
    layersDir: /layers
  dynamodb:
    stages:
      - dev
    start:
      inMemory: true
      migrate: true

provider:
  name: aws
  runtime: nodejs12.x
  region: eu-central-1
  stage: dev
  apiGateway:
    minimumCompressionSize: 1024 # Enable gzip compression for responses > 1 KB
  environment:
    IS_OFFLINE: ${opt:offline}
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1
    DYNAMODB_PRODUCTS_TABLE: ${self:service}-products
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - dynamodb:PutItem
        - dynamodb:Scan*
        - dynamodb:GetItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: arn:aws:dynamodb:#{AWS::Region}:#{AWS::AccountId}:table/${self:provider.environment.DYNAMODB_PRODUCTS_TABLE}

layers:
  HeadlessChrome:
    name: HeadlessChrome
    compatibleRuntimes:
      - nodejs12.x
    description: Required for headless chrome
    package:
      artifact: layers/chrome_aws_lambda.zip

custom:
  webpack:
    webpackConfig: ./webpack.config.js
    includeModules:
      forceExclude:
        - chrome-aws-lambda
  serverless-offline:
    location: .webpack/service
    httpPort: 4000
    useChildProcesses: true
  apigwBinary:
    types:
      - "*/*"
  dynamodb:
    stages:
      - dev
    start:
      inMemory: true
      migrate: true

functions:
  pdf:
    handler: functions/pdf.generate
    layers:
      - { Ref: HeadlessChromeLambdaLayer }
    events:
      - http:
          method: post
          path: /pdf
          cors: true

  create:
    handler: api/create.handler
    events:
      - http:
          path: /product
          method: post

  get:
    handler: api/get.handler
    events:
      - http:
          path: /product/{name}
          method: get
  
  update:
    handler: api/update.handler
    events:
      - http:
          path: /product/{name}
          method: put

  delete:
    handler: api/delete.handler
    events:
      - http:
          path: /product/{name}
          method: delete

  list:
    handler: api/list.handler
    events:
      - http:
          path: /product
          method: get

